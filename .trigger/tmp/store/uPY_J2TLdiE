{
  "version": 3,
  "sources": ["../../../../../../../../../src/trigger/index.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk/v3\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport sharp from \"sharp\";\r\n\r\n// LLM Task\r\ninterface LLMTaskPayload {\r\n    model: string;\r\n    systemPrompt: string;\r\n    userMessage: string;\r\n    images: string[];\r\n    nodeId: string;\r\n    runId: string;\r\n}\r\n\r\nexport const llmTask = task({\r\n    id: \"llm-execution\",\r\n    maxDuration: 120,\r\n    retry: {\r\n        maxAttempts: 2,\r\n    },\r\n    run: async (payload: LLMTaskPayload) => {\r\n        const { model, systemPrompt, userMessage, images, nodeId, runId } = payload;\r\n\r\n        const apiKey = process.env.GOOGLE_AI_API_KEY;\r\n        if (!apiKey) {\r\n            throw new Error(\"GOOGLE_AI_API_KEY is not configured\");\r\n        }\r\n\r\n        const genAI = new GoogleGenerativeAI(apiKey);\r\n        const modelInstance = genAI.getGenerativeModel({ model });\r\n\r\n        const parts: Array<{ text: string } | { inlineData: { mimeType: string; data: string } }> = [];\r\n\r\n        if (systemPrompt) {\r\n            parts.push({ text: `System: ${systemPrompt}\\\\n\\\\n` });\r\n        }\r\n\r\n        parts.push({ text: userMessage });\r\n\r\n        for (const imageUrl of images) {\r\n            try {\r\n                const response = await fetch(imageUrl);\r\n                const buffer = await response.arrayBuffer();\r\n                const base64 = Buffer.from(buffer).toString(\"base64\");\r\n                const mimeType = response.headers.get(\"content-type\") || \"image/jpeg\";\r\n\r\n                parts.push({\r\n                    inlineData: {\r\n                        mimeType,\r\n                        data: base64,\r\n                    },\r\n                });\r\n            } catch (error) {\r\n                console.warn(`Failed to fetch image: ${imageUrl}`, error);\r\n            }\r\n        }\r\n\r\n        const result = await modelInstance.generateContent(parts);\r\n        const response = result.response;\r\n        const text = response.text();\r\n\r\n        return {\r\n            nodeId,\r\n            runId,\r\n            response: text,\r\n            model,\r\n            tokensUsed: response.usageMetadata?.totalTokenCount || 0,\r\n        };\r\n    },\r\n});\r\n\r\n// Crop Image Task\r\ninterface CropImagePayload {\r\n    imageUrl: string;\r\n    xPercent: number;\r\n    yPercent: number;\r\n    widthPercent: number;\r\n    heightPercent: number;\r\n    nodeId: string;\r\n    runId: string;\r\n}\r\n\r\nexport const cropImageTask = task({\r\n    id: \"crop-image\",\r\n    maxDuration: 60,\r\n    retry: {\r\n        maxAttempts: 2,\r\n    },\r\n    run: async (payload: CropImagePayload) => {\r\n        const { imageUrl, xPercent, yPercent, widthPercent, heightPercent, nodeId, runId } = payload;\r\n\r\n        const response = await fetch(imageUrl);\r\n        if (!response.ok) {\r\n            throw new Error(`Failed to fetch image: ${response.statusText}`);\r\n        }\r\n\r\n        const imageBuffer = Buffer.from(await response.arrayBuffer());\r\n\r\n        const metadata = await sharp(imageBuffer).metadata();\r\n        if (!metadata.width || !metadata.height) {\r\n            throw new Error(\"Could not determine image dimensions\");\r\n        }\r\n\r\n        const left = Math.round((xPercent / 100) * metadata.width);\r\n        const top = Math.round((yPercent / 100) * metadata.height);\r\n        const width = Math.round((widthPercent / 100) * metadata.width);\r\n        const height = Math.round((heightPercent / 100) * metadata.height);\r\n\r\n        const croppedBuffer = await sharp(imageBuffer)\r\n            .extract({ left, top, width, height })\r\n            .toBuffer();\r\n\r\n        const base64 = croppedBuffer.toString(\"base64\");\r\n        const croppedUrl = `data:image/png;base64,${base64}`;\r\n\r\n        return {\r\n            nodeId,\r\n            runId,\r\n            croppedUrl,\r\n            originalDimensions: { width: metadata.width, height: metadata.height },\r\n            cropDimensions: { left, top, width, height },\r\n        };\r\n    },\r\n});\r\n\r\n// Extract Frame Task\r\ninterface ExtractFramePayload {\r\n    videoUrl: string;\r\n    timestamp: string;\r\n    nodeId: string;\r\n    runId: string;\r\n}\r\n\r\nexport const extractFrameTask = task({\r\n    id: \"extract-frame\",\r\n    maxDuration: 120,\r\n    retry: {\r\n        maxAttempts: 2,\r\n    },\r\n    run: async (payload: ExtractFramePayload) => {\r\n        const { videoUrl, timestamp, nodeId, runId } = payload;\r\n\r\n        if (!videoUrl) {\r\n            throw new Error(\"Video URL is required\");\r\n        }\r\n\r\n        let timestampSeconds = 0;\r\n        if (timestamp.includes(\":\")) {\r\n            const parts = timestamp.split(\":\").map(Number);\r\n            if (parts.length === 3) {\r\n                timestampSeconds = parts[0] * 3600 + parts[1] * 60 + parts[2];\r\n            } else if (parts.length === 2) {\r\n                timestampSeconds = parts[0] * 60 + parts[1];\r\n            }\r\n        } else {\r\n            timestampSeconds = parseFloat(timestamp) || 0;\r\n        }\r\n\r\n        return {\r\n            nodeId,\r\n            runId,\r\n            frameUrl: videoUrl,\r\n            timestamp: timestampSeconds,\r\n            status: \"frame_extraction_placeholder\",\r\n            message: \"Frame extraction requires ffmpeg integration. Video URL preserved.\",\r\n        };\r\n    },\r\n});\r\n"],
  "mappings": "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",
  "names": ["response"]
}
